---
title: "analysis_ectodecomposers"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#load packages
```{r include =FALSE}
library(readr)
library(car)
library(Rlab)
library(vegan)
library(ggplot2)
library(dplyr)
library(tidyr)
library(factoextra)
library(beepr)
library(corrgram)
library(lme4)
library(splitstackshape)
library(DHARMa)
library(ggfortify)
library(ggrepel)
```

#read in data
```{r}
datasetlist.rel.agar.15<-list(read_csv("../clean_data/SS_data_relabun_agar_15_2perc.csv"),read_csv("../clean_data/SS_data_relabun_agar_15_3perc.csv"),read_csv("../clean_data/SS_data_relabun_agar_15_4perc.csv"))
Metadata.spatial.study<-read_csv("../clean_data/Clean_spatial_study_metadata.csv")
taxsetlist.agar<-list(read_csv("../clean_data/clean_taxonimcdata_SFSI_SS_agar_2perc.csv"),read_csv("../clean_data/clean_taxonimcdata_SFSI_SS_agar_3perc.csv"),read_csv("../clean_data/clean_taxonimcdata_SFSI_SS_agar_3perc.csv"))
```


#create weight averages
```{r}
#using untransformed but scaled MnP activity per site.. everything is in same rows so can just multiply the matrix

wae.15<-as.data.frame(colSums(Meta.data.spatial$MnP_gOM_scaled*datasetlist.rel.agar.15[[2]])/colSums(datasetlist.rel.agar.15[[2]]))
colnames(wae.15)<-c("Weight.aver")

```

#permutation test of the weighted averages
```{r}
#adapted from https://towardsdatascience.com/permutation-test-in-r-77d551a9f891

permutation.test <- function(MnP, spec.data, test.stat, n){
  distribution=c()
  result=0
  for(i in 1:n){
    distribution[[i]]=colSums(sample(MnP,length(MnP),FALSE)*spec.data)/colSums(spec.data)
  }
  dist.p=as.data.frame(distribution)
  for(j in 1:nrow(test.stat)){
  result[j]=sum(dist.p[j,]>=test.stat[j,])/(n)
  } #not the abs value because I want only one side test... 
  return(list(result, distribution))#result,
}


set.seed(13)

permtest.results.15 <- permutation.test(MnP =  Meta.data.spatial$MnP_gOM_scaled, spec.data = datasetlist.rel.agar.15[[2]],test.stat = wae.15, 10000)

#plot Cort semisan
hist(as.numeric(as.data.frame(permtest.results.15[[2]])[16,]), breaks=50, col='grey', main="Permutation Distribution", las=1, xlab='')
abline(v=wae.15[which(rownames(wae.15)== "scata5690_63"),], lwd=3, col="red")

#plot suillus 
hist(as.numeric(as.data.frame(permtest.results.15[[2]])[70,]), breaks=50, col='grey', main="Permutation Distribution", las=1, xlab='')
abline(v=wae.15[which(rownames(wae.15)== "scata5690_267"),], lwd=3, col="red")


wae.perm.results.15<-as.data.frame(cbind(colnames(datasetlist.rel.agar.15[[2]]),p.adjust(permtest.results.15[[1]],method = "fdr",length(permtest.results.15[[1]])),permtest.results.15[[1]]))
wae.perm.results.15[which(wae.perm.results.15$V3 < 0.1),]
wae.perm.results.15$ID<-taxsetlist.agar[[2]][match(wae.perm.results.15$V1,taxsetlist.agar[[2]]$`Cluster ID`),]$Reference
colnames(wae.perm.results.15)<-c("Cluster_ID","adjusted_p","p","ID")


wae.perm.results.15[match(sort(wae.perm.results.15$p),wae.perm.results.15$p),]

```

```{r}
which(rownames(scores(MnP.CCA.2,choices = 1)$species) %in% taxsetlist.agar[[2]][which(taxsetlist.agar[[2]]$Class == "Agaricomycetes"),]$`Cluster ID`) #length139


scores.MnP.agar<-as.data.frame(cbind(scores(MnP.CCA.2,choices = 1)$species,rownames(scores(MnP.CCA.2,choices = 1)$species)))


scores.MnP.agar<-scores.MnP.agar[which(scores.MnP.agar$V2 %in% taxsetlist.agar[[2]][which(taxsetlist.agar[[2]]$Class == "Agaricomycetes"),]$`Cluster ID`),]

scores.MnP.agar<-scores.MnP.agar[match(scores.MnP.agar$V2,rownames(wae.15)),]

plot(scores.MnP.agar$CCA1,wae.15$Weight.aver)
text(scores.MnP.agar$CCA1,wae.15$Weight.aver,labels = rownames(wae.15))
```

