---
title: "analysis_ectodecomposers"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#load packages
```{r include =FALSE}
library(readr)
library(car)
library(Rlab)
library(vegan)
library(ggplot2)
library(dplyr)
library(tidyr)
library(factoextra)
library(beepr)
library(corrgram)
library(lme4)
library(splitstackshape)
library(DHARMa)
library(ggfortify)
library(ggrepel)
```


#read in data
```{r}
datasetlist.rel.sfsi<-read_csv("../clean_data/SFSI_data_relabun_1.5perc_filtered.csv")
datasetlist.rel.sfsi.ecm<-read_csv("../clean_data/SFSI_data_relabun_ECM_1.5perc_filtered.csv")
SFSI.soil.f2<-read_csv("../clean_data/Clean_filtered_SFSI_soil_data.csv")
```

#create scaled soil parameters
```{r}
#this centers and scales 
SFSI.soil.sel<-SFSI.soil.f2%>% mutate_at(c("Bestandsalder","Bestandsalder_log","Tallandel","Granandel","Bjorkandel","CN_log","Temperatursumma","pH_H2O_log","NC","CN","Cstock","Cstock_log"),list(scaled =scale))

#PCA of variables of interest
pca.sfsi<-prcomp(SFSI.soil.sel[,which(colnames(SFSI.soil.sel) %in% c("Bestandsalder_scaled","Granandel_scaled","pH_H2O_log_scaled","Temperatursumma_scaled","NC_scaled"))]) 
fviz_pca_biplot(pca.sfsi,invisible = "ind",axes = c(1,2))#
fviz_pca_biplot(pca.sfsi,invisible = "ind",axes = c(3,4))#

SFSI.soil.sel$pc1<- pca.sfsi$x[,1]
SFSI.soil.sel$pc2<- pca.sfsi$x[,2]
SFSI.soil.sel$pc3<- pca.sfsi$x[,3]
SFSI.soil.sel$pc4<- pca.sfsi$x[,4]

#create binary age category
SFSI.soil.sel$Bestandsaldercat<-as.factor(if_else(between(SFSI.soil.sel$Bestandsalder,0,70),"young",if_else(between(SFSI.soil.sel$Bestandsalder,70,300),"old","miss")))

#create seq platform variable
SFSI.soil.sel$seqplat<-as.numeric(if_else(SFSI.soil.sel$Taxar %in% c("2014","2015","2016"),1,2))

```


#create fungal miners guild and investigate covariates of forest properties
```{r}
miner.taxa.sfsi<-as.data.frame(cbind(datasetlist.rel.sfsi$scata6318_164,datasetlist.rel.sfsi$scata6318_298,datasetlist.rel.sfsi$scata6318_291,datasetlist.rel.sfsi$scata6318_319,datasetlist.rel.sfsi$scata6318_68,datasetlist.rel.sfsi$scata6318_252))#,datasetlist.rel.sfsi$scata5689_294
colnames(miner.taxa.sfsi)<-c("Lactarius_vietus","Gautieria_monticola","Russula_aquosa","Hysterangium","Cortinarius_semisanguineus","Cortinarius_comptulus")#,"Suillus_luteus"

miner.taxa.sfsi.ecm<-as.data.frame(cbind(datasetlist.rel.sfsi.ecm$scata6318_164,datasetlist.rel.sfsi.ecm$scata6318_298,datasetlist.rel.sfsi.ecm$scata6318_291,datasetlist.rel.sfsi.ecm$scata6318_319,datasetlist.rel.sfsi.ecm$scata6318_68,datasetlist.rel.sfsi.ecm$scata6318_252))#,datasetlist.rel.sfsi.ecm$scata5689_294
colnames(miner.taxa.sfsi.ecm)<-c("Lactarius_vietus","Gautieria_monticola","Russula_spp.","Hysterangium","Cortinarius_semisanguineus","Cortinarius_comptulus")#,"Suillus_luteus"


miner.taxa.p.sfsi<-miner.taxa.sfsi
miner.taxa.p.sfsi[miner.taxa.p.sfsi>0]<-1 # change to presence absence if rel abun is greater than zero
miner.taxa.p.sfsi[sapply(miner.taxa.p.sfsi,is.numeric)]<-lapply(miner.taxa.p.sfsi[sapply(miner.taxa.p.sfsi,is.numeric)],as.factor) #switch to factor from numeric

#relative aundace of guild as proportion of whole fungal community
miner.guild.sfsi<-rowSums(miner.taxa.sfsi) #aggreate into guild 
miner.guild.p.sfsi<-miner.guild.sfsi
miner.guild.p.sfsi[miner.guild.p.sfsi>0]<-1 #guild presence absence
miner.guild.sqrt.sfsi<-sqrt(miner.guild.sfsi) #hellinger transformation of realtive abun data

#relative aundace of guild as proportion of only ectomycorrhizal community
miner.guild.sfsi.ecm<-rowSums(miner.taxa.sfsi.ecm) #aggreate into guild 
miner.guild.sfsi.ecm[is.na(miner.guild.sfsi.ecm)]<-0 #18 samples have 0 relative abundance of ecto fungi and replace these Nan with zero
miner.guild.p.sfsi.ecm<-miner.guild.sfsi.ecm
miner.guild.p.sfsi.ecm[miner.guild.p.sfsi.ecm>0]<-1#guild presence absence
miner.guild.sqrt.sfsi.ecm<-sqrt(miner.guild.sfsi.ecm)#hellinger transformation of realtive abun data
```

## niche variables
```{r}
#bind together soil data and guild data
sfsi.fungniche<-as.data.frame(cbind(miner.taxa.sfsi,miner.taxa.sfsi.ecm,miner.taxa.p.sfsi,miner.guild.p.sfsi,miner.guild.sfsi,miner.guild.sfsi.ecm,miner.guild.sqrt.sfsi,miner.guild.sqrt.sfsi.ecm,SFSI.soil.sel$Bestandsalder_scaled,SFSI.soil.sel$Bestandsalder_log_scaled,SFSI.soil.sel$Granandel_scaled,SFSI.soil.sel$pH_H2O_log_scaled,SFSI.soil.sel$NC_scaled,SFSI.soil.sel$Temperatursumma_scaled,SFSI.soil.sel$Taxar,SFSI.soil.sel$Bestandsaldercat,SFSI.soil.sel$Cstock_log_scaled,SFSI.soil.sel$Cstock_scaled,SFSI.soil.sel$seqplat,SFSI.soil.sel$Bestandsalder))
colnames(sfsi.fungniche)<-c(colnames(miner.taxa.sfsi),paste("ecm",colnames(miner.taxa.p.sfsi)),paste("p",colnames(miner.taxa.p.sfsi)),"miners.pres","miners.rel","miners.relecm","miners.relsqrt","miners.relsqrtecm","age","age_log","spruce","pH","NC","temp","year","agecat","Cstock_log","Cstock","Seqplat","unscaled_age")

corrgram(sfsi.fungniche[,which(colnames(sfsi.fungniche) %in% c("miners.pres","age","pH","NC","spruce","temp"))],upper.panel = panel.conf,lower.panel = panel.fill)


#split into spruce and pine
hist(sfsi.fungniche$spruce)
sfsi.spruce<-sfsi.fungniche[which(sfsi.fungniche$spruce > 0 ),]
sfsi.pine<-sfsi.fungniche[which(sfsi.fungniche$spruce < 0 ),]

#the sites that are 50/50 split between spruce and pine and currently in the pine category - remove these samples
sfsi.pine<-sfsi.pine[-which(sfsi.pine$spruce > -0.01 ),]


pca.sfsi.fert.pine<-prcomp(sfsi.pine[,which(colnames(sfsi.pine) %in% c("NC","pH"))]) 
pca.sfsi.fert.spruce<-prcomp(sfsi.spruce[,which(colnames(sfsi.spruce) %in% c("NC","pH"))])
fviz_pca_biplot(pca.sfsi.fert.pine,axes = c(1,2))#,invisible = "ind"
#fviz_pca_biplot(pca.sfsi.fert,axes = c(2,3))#,invisible = "ind"
fviz_pca_biplot(pca.sfsi.fert.spruce,axes = c(1,2))#,invisible = "ind"
#fviz_pca_biplot(pca.sfsi.fert,axes = c(2,3))#,invisible = "ind"

sfsi.pine$fert.pca <-c(pca.sfsi.fert.pine$x[,1])
sfsi.spruce$fert.pca <-c(pca.sfsi.fert.spruce$x[,1]*-1)

corrgram(sfsi.fungniche[,which(colnames(sfsi.fungniche) %in% c("fert.pca","miners.pres","age","spruce"))],upper.panel = panel.conf,lower.panel = panel.fill)
corrgram(sfsi.pine[,which(colnames(sfsi.pine) %in% c("fert.pca","miners.pres","age"))],upper.panel = panel.conf,lower.panel = panel.fill)
corrgram(sfsi.spruce[,which(colnames(sfsi.spruce) %in% c("fert.pca","miners.pres","age"))],upper.panel = panel.conf,lower.panel = panel.fill)

pca.sfsi.fert.age.pine<-prcomp(sfsi.pine[,which(colnames(sfsi.pine) %in% c("fert.pca","age"))]) 
fviz_pca_biplot(pca.sfsi.fert.age.pine,axes = c(1,2))#,invisible = "ind"
#fviz_pca_biplot(pca.sfsi.fert,axes = c(2,3))#,invisible = "ind"

sfsi.pine$fert.age.pca<-c(pca.sfsi.fert.age.pine$x[,1])

pca.sfsi.fert.age.spruce<-prcomp(sfsi.spruce[,which(colnames(sfsi.spruce) %in% c("fert.pca","age"))]) 
fviz_pca_biplot(pca.sfsi.fert.age.spruce,axes = c(1,2))#,invisible = "ind"
#fviz_pca_biplot(pca.sfsi.fert,axes = c(2,3))#,invisible = "ind"

sfsi.spruce$fert.age.pca<-c(pca.sfsi.fert.age.spruce$x[,1]*-1)

#fert.age.pca axis goes in direction that more positive is older and less fertile... 
```


#GLMM of presence absence
```{r}
glm.pa.spruce<-glmer(miners.pres~age+fert.pca+(1|Seqplat),family = binomial(),data = sfsi.spruce)
#glm.pa.spruce<-glmer(miners.pres~fert.age.pca+(1|year),family = binomial(),data = sfsi.spruce) #this one tests that fer age combined...
summary(glm.pa.spruce)
Anova(glm.pa.spruce)

glm.pa.pine<-glmer(miners.pres~age+fert.pca+(1|Seqplat),family = binomial(),data = sfsi.pine)
#glm.pa.pine<-glmer(miners.pres~fert.age.pca+(1|year),family = binomial(),data = sfsi.pine)
summary(glm.pa.pine)
Anova(glm.pa.pine)


#check assumption of the glm using DHARMA https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html
simulationOutput <- simulateResiduals(fittedModel = glm.pa.spruce, plot = F)
plot(simulationOutput)
simulationOutput <- simulateResiduals(fittedModel = glm.pa.pine, plot = F)
plot(simulationOutput)
```

#create relative abun dataset with samples only where guild is present
```{r}
##remove samples where persence is zero
sfsi.pres<-sfsi.fungniche[-which(sfsi.fungniche$miners.pres == 0),]
sfsi.pine.pres<-sfsi.pine[-which(sfsi.pine$miners.pres == 0),]
sfsi.spruce.pres<-sfsi.spruce[-which(sfsi.spruce$miners.pres == 0),]

#transform 
hist(sfsi.spruce.pres$miners.relecm)
sfsi.spruce.pres$miner.relecmlog<-log(sfsi.spruce.pres$miners.relecm)
hist(sfsi.spruce.pres$miner.relecmlog)

hist(sfsi.pine.pres$miners.relecm)
sfsi.pine.pres$miner.relecmlog<-log(sfsi.pine.pres$miners.relecm)
hist(sfsi.pine.pres$miner.relecmlog)

#linear model with relecmative abun of guild to only ectomycorrhizal
#pine
lm.relecm.pine<-lmer(miner.relecmlog~age+fert.pca+(1|Seqplat),data = sfsi.pine.pres)
summary(lm.relecm.pine)
summary(aov(miner.relecmlog~age+fert.pca+(1|Seqplat),data = sfsi.pine.pres))
#summary(aov(miner.relecmlog~fert.age.pca+(1|year),data = sfsi.pine.pres))
plot(lm.relecm.pine)

#spruce
lm.relecm.spruce<-lm(miner.relecmlog~age+fert.pca,data = sfsi.spruce.pres)# change to lmer then add +(1|Seqplat)
summary(lm.relecm.spruce)
summary(aov(miner.relecmlog~age+fert.pca+(1|Seqplat),data = sfsi.spruce.pres))
#summary(aov(miner.relecmlog~fert.age.pca+(1|year),data = sfsi.spruce.pres))
plot(lm.relecm.spruce)

test.varpart<-varpart(sfsi.spruce.pres$miner.relecmlog, ~age, ~ fert.pca ,data = sfsi.spruce.pres[,which(colnames(sfsi.spruce.pres) %in% c("miner.relecmlog","age","fert.pca"))])
summary(test.varpart)
showvarparts(2)
plot(test.varpart,cutoff=-Inf)
```
##write files for plotting
```{r}
write_csv(sfsi.pine.pres,"../clean_data/SFSI_pine_guildpresent.csv")
write_csv(sfsi.spruce.pres,"../clean_data/SFSI_spruce_guildpresent.csv")
write_csv(sfsi.pine,"../clean_data/SFSI_pine.csv")
write_csv(sfsi.spruce,"../clean_data/SFSI_spruce.csv")
```


#testing individual miner taxa
```{r}
#presence/absence - fisher exact test
list.pres.abs.miners<-list(c(colnames(sfsi.pine[,13:18])))
fisher.results.pine<-list()
fisher.results.spruce<-list()
for (i in 1:6){
fisher.results.pine[[i]]<-fisher.test(as.matrix(table(sfsi.pine[,which(colnames(sfsi.pine) %in% c("agecat",list.pres.abs.miners[[1]][[i]]))])),or=1)
fisher.results.spruce[[i]]<-fisher.test(as.matrix(table(sfsi.spruce[,which(colnames(sfsi.spruce) %in% c("agecat",list.pres.abs.miners[[1]][[i]]))])),or=1)
}

fisher.results.pine
fisher.results.spruce

#Rel abun - wilcox
list.rel.miners.ecm<-list(c(colnames(sfsi.pine[,7:12])))
col.num<-list(13:18)
wilcox.results.spruce.ecm<-list()
wilcox.results.pine.ecm<-list()
for (i in 1:6){
 wilcox.results.spruce.ecm[[i]]<- wilcox.test(as.numeric(unlist(log(sfsi.spruce[which(sfsi.spruce[, col.num[[1]][i]] == "1" & sfsi.spruce$agecat == "old"),which(colnames(sfsi.spruce) == list.rel.miners.ecm[[1]][[i]])]))),as.numeric(unlist(log(sfsi.spruce[which(sfsi.spruce[,col.num[[1]][i]] == "1" & sfsi.spruce$agecat == "young"),which(colnames(sfsi.spruce) == list.rel.miners.ecm[[1]][[i]])]))))

 wilcox.results.pine.ecm[[i]]<- wilcox.test(as.numeric(unlist(log(sfsi.pine[which(sfsi.pine[, col.num[[1]][i]] == "1" & sfsi.pine$agecat == "old"),which(colnames(sfsi.pine) == list.rel.miners.ecm[[1]][[i]])]))),as.numeric(unlist(log(sfsi.pine[which(sfsi.pine[,col.num[[1]][i]] == "1" & sfsi.pine$agecat == "young"),which(colnames(sfsi.pine) == list.rel.miners.ecm[[1]][[i]])]))))
}

```
